#!/usr/bin/env ts-nodeimport { database } from '../src/config/database';

import { logger } from '../src/config/logger';

/**

 * Database Initialization Scriptconst SCHEMA_SQL = `

 * -- Users table (authentication and basic user info)

 * Initializes the Staff Scheduler database with the complete schemaCREATE TABLE IF NOT EXISTS users (

 * and creates default admin user and basic data.  id INT AUTO_INCREMENT PRIMARY KEY,

 *   email VARCHAR(255) UNIQUE NOT NULL,

 * Usage:  password_hash VARCHAR(255) NOT NULL,

 *   npm run db:init  role ENUM('admin', 'manager', 'employee') NOT NULL DEFAULT 'employee',

 *   or  is_active BOOLEAN DEFAULT TRUE,

 *   npx ts-node scripts/init-database.ts  last_login TIMESTAMP NULL,

 *   created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

 * @author Staff Scheduler Team  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

 */);



import mysql from 'mysql2/promise';-- Employees table (extended employee information)

import bcrypt from 'bcrypt';CREATE TABLE IF NOT EXISTS employees (

import * as fs from 'fs';  id INT AUTO_INCREMENT PRIMARY KEY,

import * as path from 'path';  employee_id VARCHAR(50) UNIQUE NOT NULL,

  user_id INT,

// Load environment variables  first_name VARCHAR(100) NOT NULL,

import dotenv from 'dotenv';  last_name VARCHAR(100) NOT NULL,

dotenv.config();  email VARCHAR(255) UNIQUE NOT NULL,

  phone VARCHAR(20),

interface Config {  address TEXT,

  host: string;  department VARCHAR(100),

  port: number;  position VARCHAR(100),

  user: string;  hire_date DATE,

  password: string;  employee_type ENUM('full-time', 'part-time', 'contractor') DEFAULT 'full-time',

  database: string;  hourly_rate DECIMAL(10,2),

}  max_hours_per_week INT DEFAULT 40,

  skills JSON,

const config: Config = {  certifications JSON,

  host: process.env.DB_HOST || 'localhost',  availability_pattern JSON,

  port: parseInt(process.env.DB_PORT || '3306'),  preferences JSON,

  user: process.env.DB_USER || 'root',  notes TEXT,

  password: process.env.DB_PASSWORD || '',  is_active BOOLEAN DEFAULT TRUE,

  database: process.env.DB_NAME || 'staff_scheduler'  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

};  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL

async function initializeDatabase(): Promise<void> {);

  let connection: mysql.Connection | null = null;

-- Shifts table

  try {CREATE TABLE IF NOT EXISTS shifts (

    console.log('ðŸ”§ Starting database initialization...');  id VARCHAR(36) PRIMARY KEY,

    console.log(`ðŸ“ Connecting to ${config.host}:${config.port}`);  name VARCHAR(255) NOT NULL,

  description TEXT,

    // Connect without database first to create it  start_date DATE NOT NULL,

    connection = await mysql.createConnection({  end_date DATE NOT NULL,

      host: config.host,  start_time TIME NOT NULL,

      port: config.port,  end_time TIME NOT NULL,

      user: config.user,  department VARCHAR(100),

      password: config.password,  location VARCHAR(255),

      multipleStatements: true  roles_required JSON,

    });  min_staff INT DEFAULT 1,

  max_staff INT,

    console.log('âœ… Connected to MySQL server');  status ENUM('draft', 'published', 'archived') DEFAULT 'draft',

  created_by INT,

    // Create database if not exists  published_at TIMESTAMP NULL,

    await connection.query(`CREATE DATABASE IF NOT EXISTS ${config.database} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci`);  notes TEXT,

    console.log(`âœ… Database '${config.database}' ready`);  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    // Switch to the database  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL

    await connection.query(`USE ${config.database}`););



    // Read and execute the schema SQL file-- Shift assignments table

    const schemaPath = path.join(__dirname, '../database/init.sql');CREATE TABLE IF NOT EXISTS shift_assignments (

    const schemaSql = fs.readFileSync(schemaPath, 'utf8');  id VARCHAR(36) PRIMARY KEY,

      employee_id VARCHAR(50) NOT NULL,

    console.log('ðŸ“„ Executing schema from init.sql...');  shift_id VARCHAR(36) NOT NULL,

    await connection.query(schemaSql);  role VARCHAR(100) NOT NULL,

    console.log('âœ… Database schema created successfully');  status ENUM('pending', 'approved', 'rejected', 'cancelled') DEFAULT 'pending',

  assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    // Check if admin user already exists  assigned_by INT,

    const [adminRows] = await connection.query(  approved_at TIMESTAMP NULL,

      'SELECT id FROM users WHERE email = ? LIMIT 1',  approved_by INT NULL,

      ['admin@staffscheduler.com']  rejected_at TIMESTAMP NULL,

    );  rejected_by INT NULL,

  rejection_reason TEXT,

    if (!Array.isArray(adminRows) || adminRows.length === 0) {  notes TEXT,

      // Create default admin user  FOREIGN KEY (employee_id) REFERENCES employees(employee_id) ON DELETE CASCADE,

      console.log('ðŸ‘¤ Creating default admin user...');  FOREIGN KEY (shift_id) REFERENCES shifts(id) ON DELETE CASCADE,

      const hashedPassword = await bcrypt.hash('Admin123!', 12);  FOREIGN KEY (assigned_by) REFERENCES users(id) ON DELETE SET NULL,

        FOREIGN KEY (approved_by) REFERENCES users(id) ON DELETE SET NULL,

      await connection.query(  FOREIGN KEY (rejected_by) REFERENCES users(id) ON DELETE SET NULL,

        `INSERT INTO users (email, password_hash, first_name, last_name, role, employee_id, is_active)   UNIQUE KEY unique_employee_shift (employee_id, shift_id)

         VALUES (?, ?, ?, ?, ?, ?, ?)`,);

        ['admin@staffscheduler.com', hashedPassword, 'Admin', 'User', 'admin', 'ADMIN001', true]

      );-- Time tracking table

      CREATE TABLE IF NOT EXISTS time_tracking (

      console.log('âœ… Default admin user created');  id INT AUTO_INCREMENT PRIMARY KEY,

      console.log('   Email: admin@staffscheduler.com');  assignment_id VARCHAR(36) NOT NULL,

      console.log('   Password: Admin123!');  clock_in TIMESTAMP,

      console.log('   âš ï¸  CHANGE THIS PASSWORD IN PRODUCTION!');  clock_out TIMESTAMP,

    } else {  break_start TIMESTAMP NULL,

      console.log('â„¹ï¸  Admin user already exists, skipping creation');  break_end TIMESTAMP NULL,

    }  total_hours DECIMAL(4,2),

  overtime_hours DECIMAL(4,2) DEFAULT 0,

    // Check if departments exist  status ENUM('clocked_in', 'on_break', 'clocked_out') DEFAULT 'clocked_out',

    const [deptRows] = await connection.query('SELECT COUNT(*) as count FROM departments');  notes TEXT,

    const deptCount = Array.isArray(deptRows) && deptRows.length > 0 ? (deptRows[0] as any).count : 0;  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    if (deptCount === 0) {  FOREIGN KEY (assignment_id) REFERENCES shift_assignments(id) ON DELETE CASCADE

      console.log('ðŸ¢ Creating default departments...'););

      await connection.query(`

        INSERT INTO departments (name, description, is_active) VALUES-- Schedule templates table

        ('General', 'General staff department', TRUE),CREATE TABLE IF NOT EXISTS schedule_templates (

        ('Operations', 'Daily operations and logistics', TRUE),  id VARCHAR(36) PRIMARY KEY,

        ('Administration', 'Administrative functions', TRUE)  name VARCHAR(255) NOT NULL,

      `);  description TEXT,

      console.log('âœ… Default departments created');  department VARCHAR(100),

    }  template_data JSON NOT NULL,

  is_active BOOLEAN DEFAULT TRUE,

    console.log('\nðŸŽ‰ Database initialization completed successfully!');  created_by INT,

    console.log('\nðŸ“Š Summary:');  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    console.log('   - Database schema created');  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    console.log('   - Default admin user ready');  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL

    console.log('   - Default departments created'););

    console.log('   - Default skills loaded');

    console.log('\nðŸ’¡ Next steps:');-- Employee availability table

    console.log('   1. Run: npm run demo:install (to add demo data)');CREATE TABLE IF NOT EXISTS employee_availability (

    console.log('   2. Start backend: npm run dev');  id INT AUTO_INCREMENT PRIMARY KEY,

    console.log('   3. Access: http://localhost:3001');  employee_id VARCHAR(50) NOT NULL,

  day_of_week ENUM('monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday') NOT NULL,

  } catch (error) {  start_time TIME NOT NULL,

    console.error('âŒ Database initialization failed:');  end_time TIME NOT NULL,

    console.error(error);  is_available BOOLEAN DEFAULT TRUE,

    process.exit(1);  effective_from DATE,

  } finally {  effective_to DATE,

    if (connection) {  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

      await connection.end();  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    }  FOREIGN KEY (employee_id) REFERENCES employees(employee_id) ON DELETE CASCADE

  });

}

-- Employee time off requests table

// Run if called directlyCREATE TABLE IF NOT EXISTS time_off_requests (

if (require.main === module) {  id VARCHAR(36) PRIMARY KEY,

  initializeDatabase()  employee_id VARCHAR(50) NOT NULL,

    .then(() => {  request_type ENUM('vacation', 'sick', 'personal', 'holiday') NOT NULL,

      process.exit(0);  start_date DATE NOT NULL,

    })  end_date DATE NOT NULL,

    .catch((error) => {  status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',

      console.error('Fatal error:', error);  reason TEXT,

      process.exit(1);  requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    });  reviewed_at TIMESTAMP NULL,

}  reviewed_by INT NULL,

  notes TEXT,

export { initializeDatabase };  FOREIGN KEY (employee_id) REFERENCES employees(employee_id) ON DELETE CASCADE,

  FOREIGN KEY (reviewed_by) REFERENCES users(id) ON DELETE SET NULL
);

-- Audit log table
CREATE TABLE IF NOT EXISTS audit_logs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT,
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50) NOT NULL,
  resource_id VARCHAR(100),
  old_values JSON,
  new_values JSON,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

-- Indexes for better performance
CREATE INDEX IF NOT EXISTS idx_employees_department ON employees(department);
CREATE INDEX IF NOT EXISTS idx_employees_active ON employees(is_active);
CREATE INDEX IF NOT EXISTS idx_shifts_date_range ON shifts(start_date, end_date);
CREATE INDEX IF NOT EXISTS idx_shifts_department ON shifts(department);
CREATE INDEX IF NOT EXISTS idx_shifts_status ON shifts(status);
CREATE INDEX IF NOT EXISTS idx_assignments_employee ON shift_assignments(employee_id);
CREATE INDEX IF NOT EXISTS idx_assignments_shift ON shift_assignments(shift_id);
CREATE INDEX IF NOT EXISTS idx_assignments_status ON shift_assignments(status);
CREATE INDEX IF NOT EXISTS idx_time_tracking_assignment ON time_tracking(assignment_id);
CREATE INDEX IF NOT EXISTS idx_availability_employee ON employee_availability(employee_id);
CREATE INDEX IF NOT EXISTS idx_time_off_employee ON time_off_requests(employee_id);
CREATE INDEX IF NOT EXISTS idx_time_off_dates ON time_off_requests(start_date, end_date);
CREATE INDEX IF NOT EXISTS idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
`;

export async function initializeDatabase(): Promise<void> {
  try {
    logger.info('Starting database initialization...');

    // Test database connection
    await database.testConnection();
    logger.info('Database connection verified');

    // Execute schema creation
    const statements = SCHEMA_SQL.split(';').filter(stmt => stmt.trim());
    
    for (const statement of statements) {
      if (statement.trim()) {
        await database.query(statement);
      }
    }

    logger.info('Database schema created successfully');

    // Create default admin user if it doesn't exist
    const adminExists = await database.query(
      'SELECT id FROM users WHERE email = ? LIMIT 1',
      ['admin@staffscheduler.com']
    );

    if (!adminExists || adminExists.length === 0) {
      const bcrypt = require('bcrypt');
      const hashedPassword = await bcrypt.hash('admin123', 10);
      
      await database.query(
        'INSERT INTO users (email, password_hash, role) VALUES (?, ?, ?)',
        ['admin@staffscheduler.com', hashedPassword, 'admin']
      );
      
      logger.info('Default admin user created: admin@staffscheduler.com / admin123');
    }

    logger.info('Database initialization completed successfully');
  } catch (error) {
    logger.error('Database initialization failed:', error);
    throw error;
  }
}

// Run if called directly
if (require.main === module) {
  initializeDatabase()
    .then(() => {
      logger.info('Database initialization script completed');
      process.exit(0);
    })
    .catch((error) => {
      logger.error('Database initialization script failed:', error);
      process.exit(1);
    });
}
